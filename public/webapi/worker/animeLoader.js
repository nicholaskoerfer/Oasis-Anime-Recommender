let db,finalAnimeList,filteredList,keyword,loadLimit=13,seasonOrder={fall:3,summer:2,spring:1,winter:0};self.onmessage=async({data})=>{if(!db)await IDBinit();if(data?.checkStatus){self.postMessage({isAlive:true})}else if(data?.reload!==undefined){self.postMessage({reload:data?.reload,finalAnimeList:finalAnimeList.slice(0,loadLimit),numberOfNextLoadedGrid:Math.min(Math.max(finalAnimeList.length-loadLimit,0),loadLimit)});filteredList=finalAnimeList.slice(loadLimit)}else if(data?.filterKeyword!==undefined){keyword=data?.filterKeyword;if(!keyword){filteredList=finalAnimeList}else{filteredList=finalAnimeList.filter(({title})=>{if(isJsonObject(title)){let titles=Object.values(title);return titles.some(_title=>_title?.toLowerCase?.().includes(keyword?.trim()?.toLowerCase?.()))}else{return title?.toLowerCase?.().includes(keyword?.trim()?.toLowerCase?.())}})}self.postMessage({isNew:true,finalAnimeList:filteredList.slice(0,loadLimit),numberOfNextLoadedGrid:Math.min(Math.max(filteredList.length-loadLimit,0),loadLimit)});filteredList=filteredList.slice(loadLimit)}else if(data?.removeID!==undefined){finalAnimeList=finalAnimeList.filter(({id})=>id!==data.removeID);filteredList=filteredList.filter(({id})=>id!==data.removeID);self.postMessage({isRemoved:true,removedID:data.removeID,numberOfNextLoadedGrid:Math.min(filteredList.length,loadLimit)})}else if(data?.loadMore!==undefined){self.postMessage({isNew:false,isLast:filteredList.length<=loadLimit,finalAnimeList:filteredList.slice(0,loadLimit),numberOfNextLoadedGrid:Math.min(Math.max(filteredList.length-loadLimit,0),loadLimit)});filteredList=filteredList.slice(loadLimit)}else{finalAnimeList=filteredList=[];if(data?.loadSaved){let savedFinalAnimeList=await retrieveJSON("finalAnimeList")||[];if(savedFinalAnimeList.length){finalAnimeList=savedFinalAnimeList;let hiddenEntries=await retrieveJSON("hiddenEntries")||{};self.postMessage({isNew:true,finalAnimeList:finalAnimeList.slice(0,loadLimit),hiddenEntries:hiddenEntries,numberOfNextLoadedGrid:Math.min(Math.max(finalAnimeList.length-loadLimit,0),loadLimit),hasPassedFilters:data?.hasPassedFilters});filteredList=finalAnimeList.slice(loadLimit)}}if(finalAnimeList?.length)return;self.postMessage({status:"Initializing Filters"});let activeTagFilters=data?.activeTagFilters||await retrieveJSON("activeTagFilters");let semiCautionContents={genres:{},tags:{}},cautionContents={genres:{},tags:{}};activeTagFilters?.["Content Caution"]?.forEach(({selected,filterType,optionName,optionType})=>{if(selected==="included"){if(filterType==="dropdown"){if(optionType==="genre"){semiCautionContents.genres[optionName.toLowerCase()]=true}else if(optionType==="tag"){semiCautionContents.tags[optionName.toLowerCase()]=true}}}else if(selected==="excluded"){if(filterType==="dropdown"){if(optionType==="genre"){cautionContents.genres[optionName.toLowerCase()]=true}else if(optionType==="tag"){cautionContents.tags[optionName.toLowerCase()]=true}}}});let flexibleInclusion={},include={genres:{},tags:{},season:{},format:{},status:{},userStatus:{},studios:{},year:{}},exclude={genres:{},tags:{},season:{},format:{},status:{},userStatus:{},studios:{},year:{}},comparisonFilter={weightedScore:null,score:null,averageScore:null,userScore:null,popularity:null};let hideMyAnime=false,hiddenList=false,hideWatched=false,showMyAnime=false,showAiring=false,showAllSequels=false;activeTagFilters?.["Anime Filter"]?.forEach(({selected,filterType,optionName,optionType,optionValue,CMPoperator,CMPNumber})=>{if(selected==="included"){if(filterType==="dropdown"){if(optionType==="flexible inclusion"){flexibleInclusion[optionName.replace("OR: ","").toLowerCase()]=true}else if(optionType==="genre"){include.genres[optionName.toLowerCase()]=true}else if(optionType==="tag"){include.tags[optionName.toLowerCase()]=true}else if(optionType==="year"){include.year[optionName]=true}else if(optionType==="season"){include.season[optionName.toLowerCase()]=true}else if(optionType==="format"){include.format[optionName.toLowerCase()]=true}else if(optionType==="airing status"){include.status[optionName.toLowerCase()]=true}else if(optionType==="user status"){include.userStatus[optionName.toLowerCase()]=true}else if(optionType==="studio"){include.studios[optionName.toLowerCase()]=true}}else if(filterType==="checkbox"){if(optionName.toLowerCase()==="hidden anime"){hiddenList=true}else if(optionName.toLowerCase()==="hide my anime"){hideMyAnime=true}else if(optionName.toLowerCase()==="hide watched"){hideWatched=true}else if(optionName.toLowerCase()==="show my anime"){showMyAnime=true}else if(optionName.toLowerCase()==="show airing"){showAiring=true}else if(optionName.toLowerCase()==="show all sequels"){showAllSequels=true}}else if(filterType==="input number"){if(optionName.toLowerCase()==="weighted score"){comparisonFilter.weightedScore={operator:CMPoperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="score"){comparisonFilter.score={operator:CMPoperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="average score"){comparisonFilter.averageScore={operator:CMPoperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="user score"){comparisonFilter.userScore={operator:CMPoperator,value:parseFloat(CMPNumber??optionValue)}}else if(optionName.toLowerCase()==="popularity"){comparisonFilter.popularity={operator:CMPoperator,value:parseFloat(CMPNumber??optionValue)}}}}else if(selected==="excluded"){if(filterType==="dropdown"){if(optionType==="genre"){exclude.genres[optionName.toLowerCase()]=true}else if(optionType==="tag"){exclude.tags[optionName.toLowerCase()]=true}else if(optionType==="year"){exclude.year[optionName]=true}else if(optionType==="season"){exclude.season[optionName.toLowerCase()]=true}else if(optionType==="format"){exclude.format[optionName.toLowerCase()]=true}else if(optionType==="user status"){exclude.userStatus[optionName.toLowerCase()]=true}else if(optionType==="studio"){exclude.studios[optionName.toLowerCase()]=true}}}});self.postMessage({status:"Filtering Recommendation List"});let hiddenEntries=await retrieveJSON("hiddenEntries")||{};let recommendedAnimeList=await retrieveJSON("recommendedAnimeList")||[];finalAnimeList=recommendedAnimeList.filter((anime,idx)=>{self.postMessage({progress:(idx+1)/recommendedAnimeList.length*100});if(showAiring){if(!ncsCompare(anime?.status,"releasing")){return false}}if(hideMyAnime){if(!ncsCompare(anime?.userStatus,"unwatched")){return false}}if(showMyAnime){if(ncsCompare(anime?.userStatus,"unwatched")){return false}}if(hideWatched){if(["completed","dropped"].some(e=>ncsCompare(e,anime?.userStatus))){return false}}if(hiddenList){if(hiddenEntries[anime.id]===undefined){return false}}else{if(hiddenEntries[anime.id]===true){return false}}if(comparisonFilter.userScore){let operator=comparisonFilter.userScore.operator?.trim?.(),value=comparisonFilter.userScore.value;if(typeof anime.userScore!=="number"){return false}else if(typeof operator==="string"&&typeof value==="number"){switch(operator){case">=":{if(anime.userScore<value)return false;break}case"<=":{if(anime.userScore>value)return false;break}case"<":{if(anime.userScore>=value)return false;break}case">":{if(anime.userScore<=value)return false;break}}}else if(typeof value==="number"){if(anime.userScore!==value)return false}}if(comparisonFilter.averageScore){let operator=comparisonFilter.averageScore.operator?.trim?.(),value=comparisonFilter.averageScore.value;if(typeof anime.averageScore!=="number"){return false}else if(typeof operator==="string"&&typeof value==="number"){switch(operator){case">=":{if(anime.averageScore<value)return false;break}case"<=":{if(anime.averageScore>value)return false;break}case"<":{if(anime.averageScore>=value)return false;break}case">":{if(anime.averageScore<=value)return false;break}}}else if(typeof value==="number"){if(anime.averageScore!==value)return false}}if(comparisonFilter.popularity){let operator=comparisonFilter.popularity.operator?.trim?.(),value=comparisonFilter.popularity.value;if(typeof anime.popularity!=="number"){return false}else if(typeof operator==="string"&&typeof value==="number"){switch(operator){case">=":{if(anime.popularity<value)return false;break}case"<=":{if(anime.popularity>value)return false;break}case"<":{if(anime.popularity>=value)return false;break}case">":{if(anime.popularity<=value)return false;break}}}else if(typeof value==="number"){if(anime.popularity!==value)return false}}if(comparisonFilter.weightedScore){let operator=comparisonFilter.weightedScore.operator?.trim?.(),value=comparisonFilter.weightedScore.value;if(typeof anime.weightedScore!=="number"){return false}else if(typeof operator==="string"&&typeof value==="number"){switch(operator){case">=":{if(anime.weightedScore<value)return false;break}case"<=":{if(anime.weightedScore>value)return false;break}case"<":{if(anime.weightedScore>=value)return false;break}case">":{if(anime.weightedScore<=value)return false;break}}}else if(typeof value==="number"){if(anime.weightedScore!==value)return false}}if(comparisonFilter.score){let operator=comparisonFilter.score.operator?.trim?.(),value=comparisonFilter.score.value;if(typeof anime.score!=="number"){return false}else if(typeof operator==="string"&&typeof value==="number"){switch(operator){case">=":{if(anime.score<value)return false;break}case"<=":{if(anime.score>value)return false;break}case"<":{if(anime.score>=value)return false;break}case">":{if(anime.score<=value)return false;break}}}else if(typeof value==="number"){if(anime.score!==value)return false}}if(typeof anime?.season==="string"&&!jsonIsEmpty(exclude.season)&&exclude.season[anime.season.toLowerCase()]){return false}if(typeof anime?.format==="string"&&!jsonIsEmpty(exclude.format)&&exclude.format[anime.format.toLowerCase()]){return false}if(typeof anime?.userStatus==="string"&&!jsonIsEmpty(exclude.userStatus)&&exclude.userStatus[anime.userStatus.toLowerCase()]){return false}if(typeof anime?.status==="string"&&!jsonIsEmpty(exclude.status)&&exclude.status[anime.status.toLowerCase()]){return false}if(anime?.year&&!jsonIsEmpty(exclude.year)&&exclude.year[anime.year?.toString?.()?.toLowerCase?.()]){return false}if(!jsonIsEmpty(exclude.genres)){if(anime.genres.some(e=>{if(typeof e!=="string")return false;return exclude.genres[e.toLowerCase()]}))return false}if(!jsonIsEmpty(exclude.tags)){if(anime.tags.some(e=>{let tagName=e?.name||e;if(typeof tagName!=="string")return false;return exclude.tags[tagName.toLowerCase()]}))return false}if(!jsonIsEmpty(exclude.studios)){for(let studio in anime.studios){if(typeof studio==="string"&&exclude.studios[studio?.toLowerCase?.()]){return false}}}if(!jsonIsEmpty(include.season)){if(!include.season[anime?.season?.toLowerCase?.()]){return false}}if(!jsonIsEmpty(include.format)){if(!include.format[anime?.format?.toLowerCase?.()]){return false}}if(!jsonIsEmpty(include.userStatus)){if(!include.userStatus[anime?.userStatus?.toLowerCase?.()]){return false}}if(!jsonIsEmpty(include.status)){if(!include.status[anime?.status?.toLowerCase?.()]){return false}}if(!jsonIsEmpty(include.year)){if(!include.year[anime?.year?.toString?.()?.toLowerCase?.()]){return false}}if(flexibleInclusion["genre"]){if(!jsonIsEmpty(include.genres)){if(!anime.genres.some(genre=>include.genres[genre.toLowerCase()])){return false}}}else{for(let genre in include.genres){if(!anime.genres.some(e=>{return ncsCompare(e,genre)}))return false}}if(flexibleInclusion["tag"]){if(!jsonIsEmpty(include.tags)){if(!anime.tags.some(tag=>{let tagName=tag?.name||tag;include.tags[tagName.toLowerCase()]})){return false}}}else{for(let tag in include.tags){if(!anime.tags.some(e=>{let tagName=e?.name||e;return ncsCompare(tagName,tag)}))return false}}if(flexibleInclusion["studio"]){if(!jsonIsEmpty(include.studios)){let isNotIncluded=true;for(let studio in anime.studios){if(include.studios[studio.toLowerCase()]){isNotIncluded=false;break}}if(isNotIncluded)return false}}else{let _studios=Object.keys(anime.studios);for(let studio in include.studios){if(!_studios.some(e=>{return ncsCompare(e,studio)}))return false}}let animeRelations=anime?.animeRelations;if(!showAllSequels&&animeRelations instanceof Array){let isUnwatchedSequel=!animeRelations.some(e=>{let animeRelationType=e?.relationType?.trim?.()?.toLowerCase?.();return typeof animeRelationType==="string"&&animeRelationType==="prequel"})||animeRelations.some(e=>{let animeRelationType=e?.relationType?.trim?.()?.toLowerCase?.();let animeRelationID=e?.node?.id;if(typeof animeRelationType==="string"&&animeRelationType==="prequel"&&typeof animeRelationID==="number"&&!isNaN(animeRelationID)){let relationAnime=recommendedAnimeList?.find?.(anime=>anime?.id===animeRelationID);let relationStatus=relationAnime?.userStatus?.trim?.()?.toLowerCase?.();if(relationStatus!=="unwatched"&&relationStatus!=="dropped"){return true}else{let animePopularity=anime?.popularity;let animeRelationPopularity=e?.node?.popularity;return typeof animePopularity==="number"&&!isNaN(animePopularity)&&typeof animeRelationPopularity==="number"&&!isNaN(animeRelationPopularity)&&animeRelationPopularity<=animePopularity}}});if(!isUnwatchedSequel){return false}}anime.contentCaution={caution:[],semiCaution:[]};anime.genres.forEach(genre=>{if(cautionContents.genres[genre?.toLowerCase?.()]){anime.contentCaution.caution.push(genre)}else if(semiCautionContents.genres[genre?.toLowerCase?.()]){anime.contentCaution.semiCaution.push(genre)}});anime.tags.forEach(tag=>{let tagName=tag?.name||tag;if(cautionContents.tags[tagName?.toLowerCase?.()]){anime.contentCaution.caution.push(tagName)}else if(semiCautionContents.tags[tagName?.toLowerCase?.()]){anime.contentCaution.semiCaution.push(tagName)}});if(isJsonObject(anime.favoriteContents)&&!jsonIsEmpty(anime.favoriteContents)){let sortedFavoriteContents=Object.entries(anime.favoriteContents.genres).concat(Object.entries(anime.favoriteContents.tags)).concat(Object.entries(anime.favoriteContents.studios)).sort((a,b)=>{return b[1]-a[1]}).map(([k,v])=>`${k}: (${formatNumber(v)})`);anime.sortedFavoriteContents=sortedFavoriteContents||[]}else{anime.sortedFavoriteContents=[]}return true});recommendedAnimeList=null;let filterOptions=data?.filterOptions||await retrieveJSON("filterOptions")||[];let sortFilter=filterOptions.sortFilter;let{sortName,sortType}=sortFilter?.filter(({sortType})=>sortType==="desc"||sortType==="asc")?.[0]||{sortName:"weighted score",sortType:"desc"};sortFilter=null;if(sortType==="desc"){if(sortName==="weighted score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.weightedScore),y=Number(b?.weightedScore);if(!x)return 1;if(!y)return-1;return y-x})}else if(sortName==="score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.score),y=Number(b?.score);if(!x)return 1;if(!y)return-1;return y-x})}else if(sortName==="average score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.averageScore),y=Number(b?.averageScore);if(!x)return 1;if(!y)return-1;return y-x})}else if(sortName==="user score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.userScore),y=Number(b?.userScore);if(!x)return 1;if(!y)return-1;return y-x})}else if(sortName==="popularity"){finalAnimeList.sort((a,b)=>{let x=Number(a?.popularity),y=Number(b?.popularity);if(!x)return 1;if(!y)return-1;return y-x})}else if(sortName==="date"){finalAnimeList.sort((a,b)=>{let x=a.year?a.year:Number.MIN_SAFE_INTEGER;let y=b.year?b.year:Number.MIN_SAFE_INTEGER;if(x!==y)return y-x;x=a.season?a.season.toLowerCase():"";y=b.season?b.season.toLowerCase():"";if(x!==y)return seasonOrder[y]-seasonOrder[x];x=a.weightedScore?a.weightedScore:Number.MIN_SAFE_INTEGER;y=b.weightedScore?b.weightedScore:Number.MIN_SAFE_INTEGER;return y-x})}}else if(sortType==="asc"){if(sortName==="weighted score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.weightedScore),y=Number(b?.weightedScore);if(!x)return 1;if(!y)return-1;return x-y})}else if(sortName==="score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.score),y=Number(b?.score);if(!x)return 1;if(!y)return-1;return x-y})}else if(sortName==="average score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.averageScore),y=Number(b?.averageScore);if(!x)return 1;if(!y)return-1;return x-y})}else if(sortName==="user score"){finalAnimeList.sort((a,b)=>{let x=Number(a?.userScore),y=Number(b?.userScore);if(!x)return 1;if(!y)return-1;return x-y})}else if(sortName==="popularity"){finalAnimeList.sort((a,b)=>{let x=Number(a?.popularity),y=Number(b?.popularity);if(!x)return 1;if(!y)return-1;return x-y})}else if(sortName==="date"){finalAnimeList.sort((a,b)=>{let x=a.year?a.year:Number.MAX_SAFE_INTEGER;let y=b.year?b.year:Number.MAX_SAFE_INTEGER;if(x!==y)return x-y;x=a.season?a.season.toLowerCase():"";y=b.season?b.season.toLowerCase():"";if(x!==y)return seasonOrder[x]-seasonOrder[y];x=a.weightedScore?a.weightedScore:Number.MIN_SAFE_INTEGER;y=b.weightedScore?b.weightedScore:Number.MIN_SAFE_INTEGER;return x-y})}}sortName=sortType=null;await saveJSON(activeTagFilters,"activeTagFilters");await saveJSON(filterOptions,"filterOptions");await saveJSON(finalAnimeList,"finalAnimeList");self.postMessage({status:null});self.postMessage({progress:100});self.postMessage({isNew:true,finalAnimeList:finalAnimeList.slice(0,loadLimit),hiddenEntries:hiddenEntries,numberOfNextLoadedGrid:Math.min(Math.max(finalAnimeList.length-loadLimit,0),loadLimit),hasPassedFilters:data?.hasPassedFilters});filteredList=finalAnimeList.slice(loadLimit)}};const formatNumber=(number,dec=2)=>{if(typeof number==="number"){const formatter=new Intl.NumberFormat("en-US",{maximumFractionDigits:dec,minimumFractionDigits:0,notation:"compact",compactDisplay:"short"});if(Math.abs(number)>=1e3){return formatter.format(number)}else if(Math.abs(number)<.01){return number.toExponential(0)}else{return number.toFixed(dec)||number.toLocaleString("en-US",{maximumFractionDigits:dec})}}else{return null}};function ncsCompare(str1,str2){if(typeof str1!=="string"||typeof str2!=="string"){return false}return str1.toLowerCase()===str2.toLowerCase()}async function IDBinit(){return await new Promise(resolve=>{request=indexedDB.open("Kanshi.Anime.Recommendations.Anilist.W~uPtWCq=vG$TR:Zl^#t<vdS]I~N70",1);request.onerror=error=>{console.error(error)};request.onsuccess=event=>{db=event.target.result;return resolve()};request.onupgradeneeded=event=>{db=event.target.result;db.createObjectStore("MyObjectStore");let transaction=event.target.transaction;transaction.oncomplete=()=>{return resolve()}}})}async function saveJSON(data,name){return await new Promise(async(resolve,reject)=>{try{let write=db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").openCursor();write.onsuccess=async event=>{let put=await db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").put(data,name);put.onsuccess=event=>{return resolve()};put.onerror=event=>{return resolve()}};write.onerror=async error=>{console.error(error);return reject()}}catch(ex){console.error(ex)}})}async function retrieveJSON(name){return await new Promise(resolve=>{try{let read=db.transaction("MyObjectStore","readwrite").objectStore("MyObjectStore").get(name);read.onsuccess=()=>{return resolve(read.result)};read.onerror=error=>{console.error(error);return resolve()}}catch(ex){console.error(ex);return resolve()}})}function jsonIsEmpty(obj){for(const key in obj){return false}return true}function isJsonObject(obj){return Object.prototype.toString.call(obj)==="[object Object]"}